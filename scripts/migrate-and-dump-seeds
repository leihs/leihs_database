#!/usr/bin/env bash

set -eux

LEIHS_DATABASE_NAME=${LEIHS_DATABASE_NAME:-leihs_seeds}
export DATABASE_URL="postgresql://localhost:5432/$LEIHS_DATABASE_NAME?min-pool-size=1&max-pool-size=16"
export FILE=db/structure_and_seeds.pgbin
GITREF=${GITREF:-origin/master}

{ pg_restore --version | grep -q '11.' ;} && { echo "Error! This only works with PostgreSQL v10 cli tools"; exit 1 ;}

bundle exec rake db:pg:terminate_connections || true
psql -c "DROP DATABASE IF EXISTS \"$LEIHS_DATABASE_NAME\";"
createdb $LEIHS_DATABASE_NAME
git checkout "${GITREF}" -- $FILE
bundle exec rake db:pg:structure_and_data:restore
bundle exec rake db:migrate
bundle exec rake db:pg:structure_and_data:dump
./scripts/dump-seeds

echo
echo "OK"
